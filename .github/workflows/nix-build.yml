name: Nix Build and Test

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v25
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Setup Cachix
        uses: cachix/cachix-action@v13
        with:
          name: nix-community
          authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'

      - name: Show Nix version
        run: nix --version

      - name: Build application with Nix
        run: |
          nix build .#modLoader --show-trace

      - name: Build documentation with Nix
        run: |
          nix build .#docs --show-trace

      - name: Run Rust tests
        run: |
          nix develop -c bash -c "cd mod-loader/src-tauri && cargo test --workspace"

      - name: Run checks
        run: |
          nix flake check --show-trace

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: nix-build-artifacts
          path: |
            result/bin/*.AppImage
            result-*/bin/*.AppImage

      - name: Upload documentation artifacts
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: nix-docs-artifacts
          path: |
            result-*/index.html
            result-*/*

  test-matrix:
    strategy:
      fail-fast: false
      matrix:
        system: [x86_64-linux, aarch64-linux]

    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v25
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Setup Cachix
        uses: cachix/cachix-action@v13
        with:
          name: nix-community
          authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'

      - name: Build for ${{ matrix.system }}
        run: |
          nix build .#modLoader --system ${{ matrix.system }} --show-trace || echo "Build failed for ${{ matrix.system }}"

      - name: Test for ${{ matrix.system }}
        run: |
          nix develop -c bash -c "cd mod-loader/src-tauri && cargo test --workspace" || echo "Tests failed for ${{ matrix.system }}"

  lint:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v25
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Run Rust clippy
        run: |
          nix develop -c bash -c "cd mod-loader/src-tauri && cargo clippy -- -D warnings"

      - name: Check Rust formatting
        run: |
          nix develop -c bash -c "cd mod-loader/src-tauri && cargo fmt --check"

      - name: Check documentation formatting
        run: |
          nix develop -c bash -c "cd docs && npm run lint || true"

